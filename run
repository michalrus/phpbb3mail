#!/usr/bin/perl

use strict;
use warnings;
use utf8;

use DBI;
use LWP::UserAgent;
use HTTP::Cookies;
use HTML::Entities;
use Date::Calc;
use Net::SMTP::SSL;
use File::Basename;
use Encode qw/encode decode/;
use Bytes::Random::Secure;

my $rng = Bytes::Random::Secure->new(
	Bits        => 128,
	NonBlocking => 1,
);

# ------------------------- connect to the database, create tables

my $file_cookies = dirname($0) . '/cookies.dat';
my $file_db = dirname($0) . '/data.db';

my $dbh = DBI->connect('dbi:SQLite:dbname=' . $file_db, '', '',	{ RaiseError => 1, sqlite_unicode => 1 });

my $stmt;

$dbh->do('CREATE TABLE IF NOT EXISTS post (
	id          INT  NOT NULL PRIMARY KEY,
	thread_id   INT  NOT NULL,
	thread_name TEXT NOT NULL,
	forum_id    INT  NOT NULL,
	forum_name  TEXT NOT NULL,
	author_id   INT  NOT NULL,
	author_name TEXT NOT NULL,
	date        TEXT NOT NULL,
	timestamp   INT  NOT NULL,
	message_id  TEXT
	)');
$dbh->do('CREATE INDEX IF NOT EXISTS thread_id ON post (thread_id, timestamp)');

$dbh->do('CREATE TABLE IF NOT EXISTS runtime (
	key         TEXT NOT NULL PRIMARY KEY,
	val         TEXT NOT NULL
	)');

$stmt = $dbh->prepare('INSERT OR IGNORE INTO runtime (key, val) VALUES(?, ?)');

$stmt->execute('previously_succedeed', 'yes');

# ------------------------- get new data

my $cookie_jar = HTTP::Cookies->new(
	file => $file_cookies,
	autosave => 1,
);

my $ua = LWP::UserAgent->new;
$ua->cookie_jar($cookie_jar);
$ua->agent('Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/535.2 (KHTML, like Gecko) Chrome/15.0.874.121 Safari/535.2');
push @{ $ua->requests_redirectable }, 'POST';

$ua->add_handler(request_prepare => sub {
	my($request, $ua, $h) = @_;
#	print $request->as_string(), "\n";
});

$ua->add_handler(response_header => sub {
	my($response, $ua, $h) = @_;
#	print $response->as_string(), "\n";
});

my $r = $ua->get('http://www.forum.stosowana.pl/search.php?&sr=topics&search_id=unread');

die '-ERR(1)- ', $r->status_line
	unless $r->is_success;

$r = $r->decoded_content((charset => 'UTF-8'));

if ($r =~ m/Zaloguj<\/title>/mis) {
	my $sid = '';
	if ($r =~ m/name="sid"\s+value="([^"]+)"/mis) {
		$sid = $1;
	}

	$r = $ua->post('http://www.forum.stosowana.pl/ucp.php?mode=login', [
		'username' => 'michalrus',
		'password' => '4A?%*}",i1=3w]>dFixU',
		'autologin' => '',
		'redirect' => 'search.php?&sr=topics&search_id=unread',
		'sid' => '',
		'login' => 'Zaloguj'
		]);

	die '-ERR(2)- ', $r->status_line
		unless $r->is_success;

	$r = $ua->get('http://www.forum.stosowana.pl/search.php?&sr=topics&search_id=unread');

	die '-ERR(3)- ', $r->status_line
		unless $r->is_success;

	$r = $r->decoded_content((charset => 'UTF-8'));
}

if ($r =~ m/Wyszukiwarka\s+nic\s+nie\s+znalaz≈Ça/mis) {
	exit;
}

my @tbl = split /<tr\s+valign="middle">/mis, $r;
shift @tbl;

# ------------------------- parse <tr/> rows and generate new threads

my $timestamp = time();

$stmt = $dbh->prepare('INSERT OR IGNORE INTO post
	(id, thread_id, thread_name, forum_id, forum_name, author_id, author_name, date, timestamp)
	VALUES(?, ?, ?, ?, ?, ?, ?, ?, ?)');

foreach my $row (@tbl) {
	$row =~ s/<\/tr>.*//mis;

	my $post_id = 0;
	my $thread_id = 0;
	my $thread_name = '';
	my $forum_id = 0;
	my $forum_name = '';
	my $author_id = 0;
	my $author_name = '';
	my $date = '';

	if ($row =~ m/\.\/viewtopic\.php\?f=(\d+)&amp;t=(\d+)&amp;p=(\d+)#p\d+/mis) {
		$forum_id  = $1 + 0;
		$thread_id = $2 + 0;
		$post_id   = $3 + 0;
	}
	else {
		next;
	}

	if ($row =~ m/w <a href="\.\/viewforum\.php\?f=\d+">([^<]+)<\/a>/mis) {
		$forum_name = decode_entities($1);
	}

	if ($row =~ m/class="topictitle">([^<]+)<\/a>/mis) {
		$thread_name = decode_entities($1);
	}

	if ($row =~ m/<p class="topicdetails"><a href="\.\/memberlist\.php\?mode=viewprofile&amp;u=(\d+)"[^>]*>([^<]+)<\/a>/mis) {
		$author_id   = $1 + 0;
		$author_name = decode_entities($2);
	}

	if ($row =~ m/<p class="topicdetails">[^ ]+ (\d\d [^ ]+, \d\d\d\d \d\d:\d\d)<\/p>/mis) {
		$date = decode_entities($1);
	}

	$stmt->execute($post_id, $thread_id, $thread_name, $forum_id, $forum_name, $author_id, $author_name, $date, $timestamp);

	if (0 == 1) {
		print "post_id:      " . $post_id . "\n";
		print "thread_id:    " . $thread_id . "\n";
		print "thread_name:  " . $thread_name . "\n";
		print "forum_id:     " . $forum_id . "\n";
		print "forum_name:   " . $forum_name . "\n";
		print "author_id:    " . $author_id . "\n";
		print "author_name:  " . $author_name . "\n";
		print "date:         " . $date . "\n";
		print "\n";
	}
}

# ------------------------- notify about new posts

$stmt = $dbh->prepare('SELECT id, thread_id, thread_name, forum_name, author_name, date
	FROM post WHERE message_id IS NULL
	ORDER BY timestamp ASC, id ASC');

$stmt->execute();

my $smtp;

while (my $post = $stmt->fetchrow_hashref()) {

	unless ($smtp) {
		$smtp = Net::SMTP::SSL->new('smtp.gmail.com', Port => 465, Timeout => 30, Hello => 'michalrus.com', Debug => 0)
			or die "-ERR(4)- could not connect to server; $!";

		$smtp->auth ('scripts@michalrus.com', 'yCK;*&b1.4rHVfW7zWc#')
		        or die "-ERR(5)- could not authenticate; $!";
	}

	my $message_id = '<' . $rng->string_from('abcdefghijklmnopqrstuvwxyz0123456789', 32) . '@michalrus.com>';

	my $in_reply_to = '';
	my $references = '';

	my $stmt2 = $dbh->prepare('SELECT message_id FROM post WHERE message_id IS NOT NULL AND thread_id = ? ORDER BY timestamp ASC, id ASC');
	$stmt2->execute($post->{'thread_id'});
	while (my $msg = $stmt2->fetchrow_hashref()) {
		$in_reply_to = $msg->{'message_id'};
		if (length $references) {
			$references .= "\n\t";
		}
		$references .= $in_reply_to;
	}

	my $subject = '[' . $post->{'forum_name'} . '] ' . $post->{'thread_name'};

	my $msg = '<html><head></head><body>'
		. '<p>'
		. '<a href="http://www.forum.stosowana.pl/viewtopic.php?p='
		. $post->{'id'} . '#p'
		. $post->{'id'} . '">'
		. '<i>'	. $post->{'date'} . '</i>'
		. '</a>'
		. ' by '
		. '<strong>' . $post->{'author_name'} . '</strong>'
		. '</p>'
		. '</body></html>'
		. "\n";

	if (0 == 0) {
		$smtp->mail('scripts@michalrus.com');
		$smtp->to('m@michalrus.com');

		$smtp->data();

		$smtp->datasend('To: =?UTF-8?Q?Micha=C5=82_Rus?= <m@michalrus.com>' . "\n");
		$smtp->datasend('From: Stosowana.pl <scripts@michalrus.com>' . "\n");
		$smtp->datasend('Subject: ' . encode('MIME-Q', $subject) . "\n");
		$smtp->datasend('Message-ID: ' . $message_id . "\n");
		if (length $in_reply_to) {
			$smtp->datasend('In-Reply-To: ' . $in_reply_to . "\n");
		}
		if (length $references) {
			$smtp->datasend('References: ' . $references . "\n");
		}
		$smtp->datasend('Content-Type: text/html; charset=UTF-8; format=flowed' . "\n");
		$smtp->datasend('Content-Transfer-Encoding: 8bit' . "\n");
		$smtp->datasend('MIME-Version: 1.0' . "\n");
		$smtp->datasend("\n\n");

		$smtp->datasend($msg);

		$smtp->dataend();

		$stmt2 = $dbh->prepare('UPDATE post SET message_id = ? WHERE id = ?');
		$stmt2->execute($message_id, $post->{'id'});
	}
}

if ($smtp) {
	$smtp->quit();
}
