#!/usr/bin/perl

use strict;
use warnings;
use utf8;

use LWP::UserAgent;
use HTTP::Cookies;
use Date::Calc;
use Net::SMTP::SSL;
use File::Basename;
use Encode qw/encode decode/;

# ------------------------- constants

my $file_threads = dirname($0) . '/threads.dat';
my $file_cookies = dirname($0) . '/cookies.dat';

# ------------------------- read old threads.dat

my %old_threads;

unless (-e $file_threads) {
	open (FP, '>' . $file_threads);
	close(FP);
}

open (FP, '<' . $file_threads);
while (my $line = <FP>) {
	chomp $line;
	if ($line =~ m/^\s*(\d+)\s*(\d+)\s*$/mis) {
		$old_threads{$1 + 0} = $2 + 0;
	}
}
close (FP);

# ------------------------- get new data

my $cookie_jar = HTTP::Cookies->new(
	file => $file_cookies,
	autosave => 1,
);

my $ua = LWP::UserAgent->new;
$ua->cookie_jar($cookie_jar);
$ua->agent('Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/535.2 (KHTML, like Gecko) Chrome/15.0.874.121 Safari/535.2');
push @{ $ua->requests_redirectable }, 'POST';

$ua->add_handler(request_prepare => sub {
	my($request, $ua, $h) = @_;
#	print $request->as_string(), "\n";
});

$ua->add_handler(response_header => sub {
	my($response, $ua, $h) = @_;
#	print $response->as_string(), "\n";
});

my $r = $ua->get('http://www.forum.stosowana.pl/search.php?&sr=topics&search_id=unread');

die '-ERR(1)- ', $r->status_line
	unless $r->is_success;

$r = $r->decoded_content((charset => 'UTF-8'));

if ($r =~ m/Zaloguj<\/title>/mis) {
	my $sid = '';
	if ($r =~ m/name="sid"\s+value="([^"]+)"/mis) {
		$sid = $1;
	}

	$r = $ua->post('http://www.forum.stosowana.pl/ucp.php?mode=login', [
		'username' => 'michalrus',
		'password' => '4A?%*}",i1=3w]>dFixU',
		'autologin' => '',
		'redirect' => 'search.php?&sr=topics&search_id=unread',
		'sid' => '',
		'login' => 'Zaloguj'
		]);

	die '-ERR(2)- ', $r->status_line
		unless $r->is_success;

	$r = $ua->get('http://www.forum.stosowana.pl/search.php?&sr=topics&search_id=unread');

	die '-ERR(3)- ', $r->status_line
		unless $r->is_success;

	$r = $r->decoded_content((charset => 'UTF-8'));
}

if ($r =~ m/Wyszukiwarka\s+nic\s+nie\s+znalaz≈Ça/mis) {
	exit;
}

my @tbl = split /<tr\s+valign="middle">/mis, $r;
shift @tbl;

# ------------------------- parse <tr/> rows and generate new threads

my %new_threads;

my @notify_about;

foreach my $row (@tbl) {
	$row =~ s/<\/tr>.*//mis;

	my $thread_id = 0;
	my $last_post_id = 0;
	my $forum_id = 0;
	my $forum = '';
	my $title = '';
	my $last_author = '';
	my $last_date = '';

	if ($row =~ m/\.\/viewtopic\.php\?f=(\d+)&amp;t=(\d+)&amp;p=(\d+)#p\d+/mis) {
		$thread_id = $2 + 0;
		$last_post_id = $3 + 0;
		$forum_id = $1 + 0;
	}
	else {
		next;
	}

	if ($row =~ m/w <a href="\.\/viewforum\.php\?f=\d+">([^<]+)<\/a>/mis) {
		$forum = $1;
	}

	if ($row =~ m/class="topictitle">([^<]+)<\/a>/mis) {
		$title = $1;
	}

	if ($row =~ m/<p class="topicdetails"><a href="\.\/memberlist\.php\?mode=viewprofile&amp;u=\d+"[^>]*>([^<]+)<\/a>/mis) {
		$last_author = $1;
	}

	if ($row =~ m/<p class="topicdetails">[^ ]+ (\d\d [^ ]+, \d\d\d\d \d\d:\d\d)<\/p>/mis) {
		$last_date = $1;
	}

	if (0 == 1) {
		print "thread_id:    " . $thread_id . "\n";
		print "last_post_id: " . $last_post_id . "\n";
		print "forum_id:     " . $forum_id . "\n";
		print "forum:        " . $forum . "\n";
		print "title:        " . $title . "\n";
		print "last_author:  " . $last_author . "\n";
		print "last_date:    " . $last_date . "\n";
		print "\n";
	}

	if (!exists $old_threads{$thread_id} || $old_threads{$thread_id} < $last_post_id) {
		push @notify_about, ($thread_id);
	}

	$new_threads{$thread_id} = [ $last_post_id, $forum_id, $forum, $title, $last_author, $last_date ];
}

# ------------------------- notify about @notify_about

my $num = 1 + $#notify_about;

if ($num > 0) {
	my $most_recent = $new_threads{$notify_about[0]}[5];

	my $msg = "<html><head></head><body>\n";
	my $send = 0;

	foreach my $thread_id (@notify_about) {
		$send = 1;

		$msg = $msg . '<p>'
			. '<span style="font-size:100%"><i>'	. $new_threads{$thread_id}[5] . '</i> by <strong>' . $new_threads{$thread_id}[4] . '</strong></span>'
			. '<br />'
			. '<a style="font-size:130%;" href="http://www.forum.stosowana.pl/viewtopic.php?f='
			. $new_threads{$thread_id}[1] . '&amp;t='
			. $thread_id . '&amp;p='
			. $new_threads{$thread_id}[0] . '#p'
			. $new_threads{$thread_id}[0] . '">'
			. $new_threads{$thread_id}[3] . '</a>'
			. '<br />'
			. '<span style="font-size:90%">in: <strong>' . $new_threads{$thread_id}[2] . '</strong></span>'
			. "</p>\n";
	}

	$msg .= "</body></html>\n";

	if ($send) {
		my $smtp = Net::SMTP::SSL->new('smtp.gmail.com', Port => 465, Timeout => 30, Hello => 'michalrus.com', Debug => 0)
			or die "-ERR(4)- could not connect to server; $!";

		$smtp->auth ('scripts@michalrus.com', 'yCK;*&b1.4rHVfW7zWc#')
		        or die "-ERR(5)- could not authenticate; $!";
		$smtp->mail('scripts@michalrus.com');
		$smtp->to('m@michalrus.com');

		$smtp->data();

		my $subject = '[Stosowana.pl] ';

		if ($num == 1) {
			$subject = $subject . '[' . $new_threads{$notify_about[0]}[2] . '] ' . $new_threads{$notify_about[0]}[3];
		}
		else {
			$subject = $subject . $num . ' new posts; most recent at ' . $most_recent . '.';
		}

		$smtp->datasend('To: =?UTF-8?Q?Micha=C5=82_Rus?= <m@michalrus.com>' . "\n");
		$smtp->datasend('From: phpbb3mail <scripts@michalrus.com>' . "\n");
		$smtp->datasend('Subject: ' . encode('MIME-Q', $subject) . "\n");
		$smtp->datasend('Content-Type: text/html; charset=UTF-8; format=flowed' . "\n");
		$smtp->datasend('Content-Transfer-Encoding: 8bit' . "\n");
		$smtp->datasend('MIME-Version: 1.0' . "\n");
		$smtp->datasend("\n\n");

		$smtp->datasend($msg);

		$smtp->dataend();

		$smtp->quit();
	}
}

# ------------------------- save new threads.dat

open (FP, '>' . $file_threads);
binmode FP, ":utf8";
for my $k (keys %new_threads) {
	print FP $k . "\t" . $new_threads{$k}[0] . "\n";
}
close (FP);
